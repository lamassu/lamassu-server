#!/usr/bin/env node

'use strict'

const fs = require('fs')
const path = require('path')
const bip39 = require('bip39')
const os = require('os')
const options = require('../lib/options-loader')()

const mkdirSync = (dirPath) => {
  try {
    fs.mkdirSync(dirPath)
  } catch (err) {
    if (err.code !== 'EEXIST') throw err
    throw new Error('mnemonics folder already present on home')
  }
}

if (!options.opts.mnemonicPath && options.opts.seedPath) {
  const seed = fs.readFileSync(options.opts.seedPath, 'utf8').trim()
  const words = bip39.entropyToMnemonic(seed).split(' ')

  let mnemonic = ''
  for (let i = 0; i < words.length; i += 6) {
    mnemonic += words.slice(i, i + 6).join(' ') + os.EOL
  }

  options.opts.mnemonicPath = path.resolve(os.homedir(), 'mnemonic', 'mnemonic.txt')

  mkdirSync(path.dirname(options.opts.mnemonicPath))
  fs.writeFileSync(options.opts.mnemonicPath, mnemonic, 'utf8')
  fs.writeFileSync(options.path, JSON.stringify(options.opts, null, '\t'), 'utf8')
}
